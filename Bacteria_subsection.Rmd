---
title: "Bacteria Subsection and plotting"
author: "Andreas Norlin"
date: "2023-09-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

rm(list = ls())

package.list <- c("dplyr","tidyr","ggplot2","lemon","vegan")

if(!all(package.list %in% installed.packages()[,"Package"])){
  install.packages(package.list[!(package.list %in% installed.packages()[,"Package"])])
}

library(dplyr)
library(tidyr)
library(ggplot2)
library(lemon)
library(vegan)

#Subsectioning the bacteria data from the Taxonomic and Functional Annotations file####

# tax.func <- read.csv("CSV_files/TaxonomicAndFunctionalAnnotations.csv", sep = "\t")
# 
# tax.func <- separate(tax.func,col = full_classification,into = c("Domain","Supergroup","Division","Class","Order","Family","Genus","Species"), sep = ";", remove = FALSE, fill = "right", extra = "drop")
# 
# bacteria <- tax.func[tax.func$Domain == "Bacteria",]
# 
# for(i in 1:nrow(bacteria)){
#   n.char <- nchar(bacteria$transcript_name[i])
# 
#   if(substring(bacteria$transcript_name[i], n.char-2, n.char-2) == "."){
#     bacteria$SequenceID[i] <- substring(bacteria$transcript_name[i],1,n.char-3)
# 
#   } else if(substring(bacteria$transcript_name[i], n.char-3, n.char-3) == "."){
#     bacteria$SequenceID[i] <- substring(bacteria$transcript_name[i],1,n.char-4)
# 
#   }
# }
# write.csv(bacteria,"CSV_files/Bacteria.subsection.TFA.csv", row.names = F)

#Using the sequence ID's from the bacteria subsection to subsection the numreads and the TPM files####

# Bacteria <- read.csv("CSV_files/bacteria.subsection.TFA.csv")
# 
# salmon.numread <- read.csv("CSV_files/salmon.merged.numreads.subset5.csv")
# filter <- salmon.numread$Name %in% bacteria$SequenceID
# 
# Bacteria.numread <- salmon.numread[filter,]
# write.csv(Bacteria.numread,"CSV_files/Bacteria.subsection.numreads.csv",row.names = F)
# 
# salmon.TPM <- read.csv("CSV_files/salmon.merged.TPM.subset5.csv")
# 
# Bacteria.TPM <- salmon.TPM[filter,]
# write.csv(Bacteria.TPM, "CSV_files/Bacteria.subsection.TPM.csv",row.names = F)

#Reading the Bacteria numread and TPM subsectioned files.####

meta.data <- read.csv("CSV_files/dielRNA_eukrythmic.tsv", sep = "\t")

#Raw read
Bacteria.numread <- read.csv("CSV_files/Bacteria.subsection.numreads.csv")

#Transcripts per million
Bacteria.TPM <- read.csv("CSV_files/Bacteria.subsection.TPM.csv")

# Bacteria.TFA <- read.csv("CSV_files/bacteria.subsection.TFA.csv")
# #Filtering out the sequences present in the Taxonomy and functional annotations data, but not in the numread/TPM
# filter <- Bacteria.TFA$SequenceID %in% Bacteria.numread$Name
# 
# Bacteria.TFA <- Bacteria.TFA[filter,]
```

Filter for kegg.ko then add the rest afterwards.
Try to optimize the sorting

```{r Data cleaning}
# unique.vec <- unique(Bacteria.TFA$SequenceID)
# 
# for(i in 1:length(unique.vec)){
#   if(i == 1){
#     Time1 <- Sys.time()
#     Time2 <- Sys.time()
# 
#     n <- 1
#     df <- data.frame(matrix(ncol = ncol(Bacteria.TFA), nrow = length(unique.vec)))
#     names(df) <- names(Bacteria.TFA)
#   }
# 
#   vec <- Bacteria.TFA[Bacteria.TFA$SequenceID == unique.vec[i],]
# 
#   if(nrow(vec) == 1){
#     df[n,] <- vec
# 
#     n <- n+1
# 
#   } else {
#     filter <- vec$KEGG_ko == "-"
# 
#     if(sum(filter) == 1){
# 
#       df[n,] <- vec[filter,]
# 
#       n <- n+1
#     } else {
#       df[n,] <- vec[1,]
# 
#       n <- n+1
#     }
#   }
# 
#   if(i %% 5000 == 0){
#     print(paste("i = ", i , " out of ", length(unique.vec),sep = ""))
# 
#     print(paste("time since start: ", round(Sys.time() - Time1,1)," minutes", sep = ""))
#     print(paste("Time since last: ", round(Sys.time() - Time2,1)," minutes", sep = ""))
# 
#     Time2 <- Sys.time()
#   }
# 
#   if(i == length(unique.vec)){
#     df <- df[!is.na(df$X),]
#   }
# }
# 
# write.csv(df,"CSV_files/Bacteria.TFA_NoRep.csv",row.names = F)
```


```{r}
Bacteria.TFA <- read.csv("CSV_files/Bacteria.TFA_NoRep.csv")
Bacteria.TFA$Class <- ifelse(substring(Bacteria.TFA$Class,nchar(Bacteria.TFA$Class)-7) == " (Class)",
                             substring(Bacteria.TFA$Class,1,nchar(Bacteria.TFA$Class)-8),
                             Bacteria.TFA$Class)

names(Bacteria.numread)[1] <- "SequenceID"

df.merged <- merge(Bacteria.numread,Bacteria.TFA,by = "SequenceID")
df.merged$Class <- substring(df.merged$Class,2)

df.merged$Class[is.na(df.merged$Class)] <- "Unclassified"


Class.vec <- unique(df.merged$Class)
n <- length(Class.vec)

day.vec <- paste(meta.data$SampleID,"_quant",sep = "")
m <- length(day.vec)

for(i in 1:n){ #Looping through the Classes to count the occurrences.
  
  Class.filter <- df.merged$Class == Class.vec[i]
  df.temp <- df.merged[Class.filter,]
  
  for(j in 1:m){ #Looping through the sampling time points.
    
   if(i == 1 & j == 1){ #Sets up an empty data.frame to input the data
     
     df.count <- data.frame(matrix(ncol = m, nrow = n))
     names(df.count) <- meta.data$SampleName
     
     df.count <- cbind(df.count,Class.vec)
   }
    
    df.count[i,j] <- sum(df.temp[,day.vec[j]])/sum(df.merged[,day.vec[j]])
    
  }
}

df.merged2 <- df.merged[df.merged$Class != "Unclassified",]

top5.vec <- names(table(df.merged2$Class)[order(-table(df.merged2$Class))[1:5]])

top5.filter <- df.count$Class.vec %in% c(top5.vec,"Unclassified")

df.top5 <- df.count[top5.filter,]
df.other <- df.count[!top5.filter,]

df.count2 <- rbind(df.top5,c(colSums(df.other[,1:24]),"Other"))

order.vec <- c("Day1_morning1",   "Day1_morning2",   "Day1_morning3",
               "Day1_afternoon1", "Day1_afternoon2", "Day1_afternoon3",
               "Day1_evening1",   "Day1_evening2",   "Day1_evening3",
               "Day1_night1",     "Day1_night2",     "Day1_night3",
               "Day2_morning1",   "Day2_morning2",   "Day2_morning3",
               "Day2_afternoon1", "Day2_afternoon2", "Day2_afternoon3",
               "Day2_evening1",   "Day2_evening2",   "Day2_evening3",
               "Day2_night1",     "Day2_night2",     "Day2_night3")

dfOut <- pivot_longer(df.count2,
                      all_of(meta.data$SampleName),
                      names_to = "Day",
                      values_to = "Count")

p1 <- ggplot(dfOut)+
  geom_bar(aes(fill = factor(Class.vec,
                             levels = c("Unclassified","Other",top5.vec)),
               y = as.numeric(Count),
               x = factor(Day, level = order.vec)),
           position = "stack", stat = "identity")+
  theme(axis.text.x = element_text(angle = 90,
                                   vjust = 0.5,
                                   hjust=1))+
  guides(fill = guide_legend(title = "Class"))

p1
```
The 1, 2, and 3 are replicates, so they can be averaged and error bars added.

Make som plots with meta-data

make some plots with the cogs, split data and double count.

Try to look at the KEGG data
```{r}
Bacteria.TFA <- read.csv("CSV_files/Bacteria.TFA_NoRep.csv")
Bacteria.TFA$Class <- ifelse(substring(Bacteria.TFA$Class,nchar(Bacteria.TFA$Class)-7) == " (Class)",
                             substring(Bacteria.TFA$Class,1,nchar(Bacteria.TFA$Class)-8),
                             Bacteria.TFA$Class)

names(Bacteria.numread)[1] <- "SequenceID"

df.merged <- merge(Bacteria.numread,Bacteria.TFA,by = "SequenceID")
df.merged$Class <- substring(df.merged$Class,2)

df.merged$Class[is.na(df.merged$Class)] <- "Unclassified"


Class.vec <- unique(df.merged$Class)
n <- length(Class.vec)

day.vec <- paste(meta.data$SampleID,"_quant",sep = "")
m <- length(day.vec)

for(i in 1:n){ #Looping through the Classes to count the occurrences.
  
  Class.filter <- df.merged$Class == Class.vec[i]
  df.temp <- df.merged[Class.filter,]
  
  for(j in 1:m){ #Looping through the sampling time points.
    
   if(i == 1 & j == 1){ #Sets up an empty data.frame to input the data
     
     df.count <- data.frame(matrix(ncol = m, nrow = n))
     names(df.count) <- meta.data$SampleName
     
     df.count <- cbind(df.count,Class.vec)
   }
    
    df.count[i,j] <- mean(df.temp[,day.vec[j]])
    
  }
}

order.vec <- c("Day1_morning1",   "Day1_morning2",   "Day1_morning3",
               "Day1_afternoon1", "Day1_afternoon2", "Day1_afternoon3",
               "Day1_evening1",   "Day1_evening2",   "Day1_evening3",
               "Day1_night1",     "Day1_night2",     "Day1_night3",
               "Day2_morning1",   "Day2_morning2",   "Day2_morning3",
               "Day2_afternoon1", "Day2_afternoon2", "Day2_afternoon3",
               "Day2_evening1",   "Day2_evening2",   "Day2_evening3",
               "Day2_night1",     "Day2_night2",     "Day2_night3")

dfOut <- pivot_longer(df.count,
                      all_of(meta.data$SampleName),
                      names_to = "Day",
                      values_to = "Count")

dfOut <- dfOut[dfOut$Class.vec == unique(dfOut$Class.vec)[1],]

p2 <- ggplot(data = dfOut)+
  geom_line(aes(x = factor(Day, level = order.vec),
                y = Count,
                group = 1,
                color = Class.vec))+
  theme(axis.text.x = element_text(angle = 90,
                                   vjust = 0.5,
                                   hjust=1))

p2
```


```{r}
Class.vec <- unique(df.merged$Class)

for(j in 1:length(Class.vec)){
  if(j == 1){
    df.mean <- 0
  }
  for(i in 1:24){
    
    if(i == 1){
      vec <- rep(NA,24)
    }
    
    vec[i] <- mean(df.merged[df.merged$Class == "Actinobacteria",i+1])
  }
}


```


```{r Bacteria data}
Bacteria.TFA <- read.csv("CSV_files/Bacteria.TFA_NoRep.csv")

dfOut <- Bacteria.TFA

# Create a bar plot
ggplot(dfOut, aes(x = Class))+
  geom_bar()+
  scale_y_log10()+
  labs(title = "Class Distribution",
       x = "Class",
       y = "Count")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


```


